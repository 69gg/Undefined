name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å¿…é¡»æ‹‰å–å®Œæ•´åŽ†å²æ‰èƒ½è¯»å– Tag æ³¨é‡Š

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.12

      - name: Build project
        run: uv build

      - name: Create Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. æ£€æŸ¥æ˜¯å¦ä¸ºæ³¨è§£æ ‡ç­¾ (Annotated Tag)
          # å¦‚æžœæ˜¯è½»é‡æ ‡ç­¾ (Lightweight Tag)ï¼Œgit cat-file -t ä¼šè¿”å›ž "commit"
          # å¦‚æžœæ˜¯æ³¨è§£æ ‡ç­¾ï¼Œåˆ™è¿”å›ž "tag"
          TAG_TYPE=$(git cat-file -t ${{ github.ref_name }})
          TAG_CONTENT=""
          
           if [ "$TAG_TYPE" = "tag" ]; then
             # ç²¾ç¡®æå– Tag Message (ä»…å†…å®¹ï¼Œä¸åŒ…å«taggerä¿¡æ¯)
             TAG_CONTENT=$(git tag -l --format='%(contents:subject)' ${{ github.ref_name }})
             
             # å¦‚æžœsubjectä¸ºç©ºï¼Œå°è¯•èŽ·å–body
             if [ -z "$TAG_CONTENT" ]; then
               TAG_CONTENT=$(git tag -l --format='%(contents:body)' ${{ github.ref_name }})
             fi
           fi
          
          # 2. èŽ·å–ä¸Šä¸€ä¸ª Tag
          PREV_TAG=$(git describe --tags --abbrev=0 ${{ github.ref_name }}^ 2>/dev/null || git rev-list --max-parents=0 HEAD)
          
          # 3. åˆå§‹åŒ– tag_message.txt
          if [ -n "$TAG_CONTENT" ]; then
            # ç§»é™¤ PGP ç­¾åï¼ˆå¦‚æžœå­˜åœ¨ï¼‰å¹¶å†™å…¥
            echo "$TAG_CONTENT" | sed '/-----BEGIN PGP SIGNATURE-----/,/-----END PGP SIGNATURE-----/d' > tag_message.txt
            echo -e "\n---\n" >> tag_message.txt
          else
            touch tag_message.txt
          fi
          
          # 4. è¿½åŠ â€œDetailed Changesâ€æ ‡é¢˜
          echo -e "## ðŸ“ Detailed Changes\n" >> tag_message.txt
          
          # 5. è‡ªåŠ¨ç”ŸæˆåŸºäºŽ Commit çš„è¯¦ç»†åˆ—è¡¨ (Angular è§„èŒƒåˆ†ç±»)
          echo -e "### ðŸš€ Features" >> tag_message.txt
          git log ${PREV_TAG}..${{ github.ref_name }} --grep="^feat" --pretty=format:"* %s (%h)" >> tag_message.txt || true
          echo -e "\n" >> tag_message.txt
          
          echo -e "### ðŸ› Bug Fixes" >> tag_message.txt
          git log ${PREV_TAG}..${{ github.ref_name }} --grep="^fix" --pretty=format:"* %s (%h)" >> tag_message.txt || true
          echo -e "\n" >> tag_message.txt
          
          echo -e "### ðŸ›  Maintenance & Others" >> tag_message.txt
          git log ${PREV_TAG}..${{ github.ref_name }} --grep="^feat\|^fix" --invert-grep --pretty=format:"* %s (%h)" >> tag_message.txt || true
          
          # 6. åˆ›å»º Release
          gh release create ${{ github.ref_name }} dist/* \
            --title "Undefined ${{ github.ref_name }}" \
            --notes-file tag_message.txt \
            --generate-notes
